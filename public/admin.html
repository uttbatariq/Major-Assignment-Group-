<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Excursion Society</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="container">
        <h1>üîê Admin Dashboard</h1>
        <nav>
          <a href="index.html">Back to Site</a>
        </nav>
      </div>
    </header>

    <main class="container">
    <section id="login-section" class="login-section">
      <h2>Admin Login</h2>
      <form id="login-form">
        <label for="a-user">Username</label>
        <input id="a-user" placeholder="Enter username" required />
        <label for="a-pass">Password</label>
        <input id="a-pass" placeholder="Enter password" type="password" required />
        <button type="submit" class="btn-primary" style="width: 100%;">Sign In</button>
      </form>
      <div id="login-msg" class="login-msg"></div>
    </section>

    <section id="admin-panel" class="hidden">
      <div class="section-title">
        <h2>Dashboard</h2>
      </div>

      <div class="admin-panel">
        <!-- Create Tour Card -->
        <div class="admin-card">
          <h3>‚ûï Create New Tour</h3>
          <input id="t-title" placeholder="Tour Title" />
          <input id="t-price" placeholder="Price ($)" />
          <input id="t-date" placeholder="Date (YYYY-MM-DD)" />
          <textarea id="t-desc" placeholder="Tour Description" rows="3" style="resize: vertical;"></textarea>
          <button id="create-tour" class="btn-secondary" style="width: 100%;">Create Tour</button>
        </div>

        <!-- Tours List Card -->
        <div class="admin-card">
          <h3>üìã Tours Management</h3>
          <div id="admin-tours" class="admin-list">
            <p style="color: var(--text-light); text-align: center;">Loading tours...</p>
          </div>
        </div>

        <!-- Analytics Card -->
        <div class="admin-card">
          <h3>üìä Analytics & Revenue</h3>
          <label for="analytics-tour-id">Tour ID:</label>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input id="analytics-tour-id" placeholder="Enter Tour ID" type="number" style="flex: 1; margin: 0;" />
            <button id="check-analytics" class="btn-primary">Check</button>
          </div>
          <pre id="analytics-result" style="display: none;"></pre>
          <p id="analytics-placeholder" style="color: var(--text-light); text-align: center;">Select a tour to view analytics</p>
        </div>

        <!-- Registrations Card -->
        <div class="admin-card">
          <h3>üë• Registrations Details</h3>
          <label for="regs-tour-id">Tour ID:</label>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input id="regs-tour-id" placeholder="Enter Tour ID" type="number" style="flex: 1; margin: 0;" />
            <button id="check-regs" class="btn-primary">View</button>
          </div>
          <div id="registrations-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </section>

    <script>
      const API = 'http://localhost:5000';
      let token = null;

      document.getElementById('login-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const u = document.getElementById('a-user').value;
        const p = document.getElementById('a-pass').value;
        const res = await fetch(API + '/admin/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
        const data = await res.json();
        if(data.token){
          token = data.token;
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          document.getElementById('admin-panel').classList.add('block');
          const msg = document.getElementById('login-msg');
          msg.classList.add('hidden');
          loadAdminTours();
        } else {
          const msg = document.getElementById('login-msg');
          msg.classList.remove('hidden');
          msg.classList.add('block');
          msg.textContent = data.error || 'Login failed';
        }
      });

      async function loadAdminTours(){
        const res = await fetch(API + '/tours');
        const tours = await res.json();
        const out = document.getElementById('admin-tours');
        out.innerHTML = '';
        if(tours.length === 0){
          out.innerHTML = '<p style="color: var(--text-light); text-align: center;">No tours yet</p>';
          return;
        }
        tours.forEach(t=>{
          const div = document.createElement('div');
          div.className = 'admin-item';
          div.innerHTML = `<div class="admin-item-info"><div class="admin-item-id">#${t.id}</div><div class="admin-item-title">${t.title}</div></div><div class="admin-item-price">$${t.price}</div><div class="admin-buttons"><button data-id="${t.id}" class="regs btn-primary btn-small">Details</button><button data-id="${t.id}" class="delete btn-danger btn-small">Delete</button></div>`;
          out.appendChild(div);
        });
        document.querySelectorAll('.delete').forEach(btn=>btn.addEventListener('click', deleteTour));
        document.querySelectorAll('.regs').forEach(btn=>btn.addEventListener('click', showRegs));
      }

      async function deleteTour(e){
        if(!confirm('Are you sure you want to delete this tour?')) return;
        const id = e.target.dataset.id;
        await fetch(API + '/tours/' + id, {method:'DELETE', headers:{'X-ADMIN-TOKEN': token}});
        loadAdminTours();
      }

      async function showRegs(e){
        const id = e.target.dataset.id;
        const res = await fetch(API + '/registrations/tour/' + id, {headers:{'X-ADMIN-TOKEN': token}});
        const data = await res.json();
        const out = document.getElementById('registrations-list');
        out.innerHTML = '';
        if(data.length === 0){
          out.innerHTML = '<p style="color: var(--text-light);">No registrations for this tour</p>';
          return;
        }
        data.forEach(r=>{
          const div = document.createElement('div');
          div.className = 'admin-item';
          div.innerHTML = `<div><strong>${r.name}</strong><br><small>${r.email || 'No email'}</small></div><div style="text-align: right;"><strong>${r.seats} seats</strong><br><small>$${r.total_price}</small></div>`;
          out.appendChild(div);
        });
      }

      document.getElementById('create-tour').addEventListener('click', async ()=>{
        const title = document.getElementById('t-title').value;
        const price = parseFloat(document.getElementById('t-price').value);
        const date = document.getElementById('t-date').value;
        const desc = document.getElementById('t-desc').value;
        if(!title || !price){
          alert('Please fill in title and price');
          return;
        }
        const res = await fetch(API + '/tours', {method:'POST', headers:{'Content-Type':'application/json','X-ADMIN-TOKEN': token}, body: JSON.stringify({title,price,date,description:desc})});
        if(res.ok){
          document.getElementById('t-title').value = '';
          document.getElementById('t-price').value = '';
          document.getElementById('t-date').value = '';
          document.getElementById('t-desc').value = '';
          loadAdminTours();
          alert('Tour created successfully!');
        }
      });

      document.getElementById('check-analytics').addEventListener('click', async ()=>{
        const id = document.getElementById('analytics-tour-id').value;
        if(!id) { alert('Please enter a tour ID'); return; }
        const reg = await fetch(API + '/analytics/tour/' + id + '/registrations', {headers:{'X-ADMIN-TOKEN': token}}).then(r=>r.json());
        const rev = await fetch(API + '/analytics/tour/' + id + '/revenue', {headers:{'X-ADMIN-TOKEN': token}}).then(r=>r.json());
        document.getElementById('analytics-result').style.display = 'block';
        document.getElementById('analytics-placeholder').style.display = 'none';
        document.getElementById('analytics-result').textContent = JSON.stringify({registrations: reg, revenue: rev}, null, 2);
      });

      document.getElementById('check-regs').addEventListener('click', async ()=>{
        const id = document.getElementById('regs-tour-id').value;
        if(!id) { alert('Please enter a tour ID'); return; }
        const res = await fetch(API + '/registrations/tour/' + id, {headers:{'X-ADMIN-TOKEN': token}});
        const data = await res.json();
        const out = document.getElementById('registrations-list');
        out.innerHTML = '';
        if(data.length === 0){
          out.innerHTML = '<p style="color: var(--text-light);">No registrations for this tour</p>';
          return;
        }
        data.forEach(r=>{
          const div = document.createElement('div');
          div.className = 'admin-item';
          div.innerHTML = `<div><strong>${r.name}</strong><br><small>${r.email || 'No email'}</small></div><div style="text-align: right;"><strong>${r.seats} seats</strong><br><small>$${r.total_price}</small></div>`;
          out.appendChild(div);
        });
      });
    </script>

    <footer>
      <p>&copy; 2024 Excursion Society Admin. All rights reserved.</p>
    </footer>
  </body>
</html>
